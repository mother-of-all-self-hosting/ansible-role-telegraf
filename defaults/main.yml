# SPDX-FileCopyrightText: 2023 Julian-Samuel Gebühr
# SPDX-FileCopyrightText: 2023 - 2024 Nikita Chernyi
# SPDX-FileCopyrightText: 2023 - 2025 Slavi Pantaleev
# SPDX-FileCopyrightText: 2024 Sergio Durigan Junior
# SPDX-FileCopyrightText: 2025 MASH project contributors
# SPDX-FileCopyrightText: 2025 Suguru Hirahara
#
# SPDX-License-Identifier: AGPL-3.0-or-later

---

telegraf_enabled: true

telegraf_identifier: telegraf
telegraf_base_path: "/{{ telegraf_identifier }}"
telegraf_data_path: "{{ telegraf_base_path }}/data"

# renovate: datasource=docker depName=library/telegraf versioning=semver
telegraf_version: 1.37.3

telegraf_uid: ""
telegraf_gid: ""

telegraf_container_image: "{{ telegraf_container_image_registry_prefix }}library/telegraf:{{ telegraf_container_image_tag }}"
telegraf_container_image_tag: "{{ telegraf_version }}"
telegraf_container_image_registry_prefix: "{{ telegraf_container_image_registry_prefix_upstream }}"
telegraf_container_image_registry_prefix_upstream: "{{ telegraf_container_image_registry_prefix_upstream_default }}"
telegraf_container_image_registry_prefix_upstream_default: docker.io/
telegraf_container_image_force_pull: "{{ telegraf_container_image.endswith(':latest') }}"

# The base container network. It will be auto-created by this role if it doesn't exist already.
telegraf_container_network: "{{ telegraf_identifier }}"

# Control if the container network is deleted on uninstalling.
telegraf_container_network_deletion_enabled: true

# A list of additional container networks that the container would be connected to.
# The role does not create these networks, so make sure they already exist.
# Use this to expose this container to a reverse proxy, which runs in a different container network and InfluxDB.
telegraf_container_additional_networks: "{{ telegraf_container_additional_networks_auto + telegraf_container_additional_networks_custom }}"
telegraf_container_additional_networks_auto: []
telegraf_container_additional_networks_custom: []

# A list of extra arguments to pass to the container (`docker create` command)
telegraf_container_extra_arguments: "{{ telegraf_container_extra_arguments_auto + telegraf_container_extra_arguments_custom }}"
telegraf_container_extra_arguments_auto: []
telegraf_container_extra_arguments_custom: []

# List of systemd services that the Telegraf systemd service depends on
telegraf_systemd_required_services_list: "{{ telegraf_systemd_required_services_list_default + telegraf_systemd_required_services_list_auto + telegraf_systemd_required_services_list_custom }}"
telegraf_systemd_required_services_list_default: "{{ [devture_systemd_docker_base_docker_service_name] if devture_systemd_docker_base_docker_service_name else [] }}"
telegraf_systemd_required_services_list_auto: []
telegraf_systemd_required_services_list_custom: []

# List of systemd services that the Telegraf systemd service wants
telegraf_systemd_wanted_services_list: "{{ telegraf_systemd_wanted_services_list_default + telegraf_systemd_wanted_services_list_auto + telegraf_systemd_wanted_services_list_custom }}"
telegraf_systemd_wanted_services_list_default: []
telegraf_systemd_wanted_services_list_auto: []
telegraf_systemd_wanted_services_list_custom: []

# Controls how long to wait for the container to stop gracefully before killing it.
telegraf_container_stop_grace_time_seconds: "{{ devture_systemd_docker_base_container_stop_grace_time_seconds }}"

# Controls how long the pre-start cleanup should wait for stale container-name release
# before failing startup explicitly.
telegraf_container_cleanup_timeout_seconds: "{{ devture_systemd_docker_base_container_cleanup_timeout_seconds }}"

# Controls the delay between pre-start cleanup retries.
telegraf_container_cleanup_retry_delay_seconds: "{{ devture_systemd_docker_base_container_cleanup_retry_delay_seconds }}"

# Shell command used in the systemd pre-start phase to deterministically remove a stale
# container and wait until Docker releases its name.
telegraf_container_cleanup_command: |
  i=0;
  while [ "$i" -lt {{ telegraf_container_cleanup_timeout_seconds }} ]; do
  {{ devture_systemd_docker_base_host_command_docker }} stop -t {{ telegraf_container_stop_grace_time_seconds }} {{ telegraf_identifier }} >/dev/null 2>&1 || true;
  {{ devture_systemd_docker_base_host_command_docker }} rm -f {{ telegraf_identifier }} >/dev/null 2>&1 || true;
  if {{ devture_systemd_docker_base_host_command_docker }} container inspect {{ telegraf_identifier }} >/dev/null 2>&1; then
  i=$((i + 1));
  sleep {{ telegraf_container_cleanup_retry_delay_seconds }};
  continue;
  fi;
  if {{ devture_systemd_docker_base_host_command_docker }} info >/dev/null 2>&1; then
  exit 0;
  fi;
  echo "Failed to query Docker daemon while cleaning up {{ telegraf_identifier }}" >&2;
  exit 1;
  done;
  echo "Failed to remove stale container {{ telegraf_identifier }} after {{ telegraf_container_cleanup_timeout_seconds }} attempts" >&2;
  exit 1

# Specify the timezone
telegraf_environment_variables_tz: UTC

# The following must be set to enable Telegraf to be configured via InfluxDB
# You need to obtain these values in a set-up InfluxDB via Load Data -> Telegraf
# then adding a Telegraf configuration. Then you should copy these values from the setup instructions.
telegraf_influx_token: ""
telegraf_config_link: ""

# Set true to get a lot more logs on Telegraf's behaviour
telegraf_debug: false

# Additional environment variables to pass to the Telegraf container.
# You can use this to further influence the default configuration.
#
# Example:
# telegraf_environment_variables_additional_variables: |
#   INFLUXD_BOLT_PATH=/root/telegraf.bolt
#   DOCKER_telegraf_INIT_RETENTION=90d
telegraf_environment_variables_additional_variables: ""

# telegraf_restart_necessary controls whether the Telegraf systemd
# service will be restarted (when true) or merely started (when false) by the
# systemd service manager role (when conditional restart is enabled).
#
# This value is automatically computed during installation based on whether
# any configuration files, the systemd service file, or the container image changed.
# The default of `false` means "no restart needed" — appropriate when the role's
# installation tasks haven't run (e.g., due to --tags skipping them).
telegraf_restart_necessary: false
